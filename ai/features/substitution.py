"""
대체 재료 추천 시스템

없는 재료를 대체할 수 있는 재료와 비율 정보를 제공합니다.

Features:
    - 대체 가능한 재료 목록 제공
    - 대체 비율 정보
    - 대체 시 맛/특성 변화 안내
    - 카테고리별 대체재료 검색

Example:
    >>> sub = IngredientSubstitution()
    >>> info = sub.get_substitutes("양파")
    >>> print(info['대체재료'])
    ['파', '대파', '양파가루', '샬롯', '부추']
    >>> print(sub.format_substitution_info("마늘"))
"""

from typing import Dict, List, Optional


class IngredientSubstitution:
    """
    대체 재료 추천 시스템
    
    요리 중 특정 재료가 없을 때 대체할 수 있는 재료와
    적절한 대체 비율, 맛의 변화를 안내합니다.
    
    등록된 재료:
        - 기본 채소류 (양파, 대파, 마늘, 생강, 고추)
        - 장류/양념 (된장, 간장)
        - 기름류 (식용유)
        - 유제품 (우유, 버터)
        
    Example:
        >>> sub = IngredientSubstitution()
        >>> 
        >>> # 대체 재료 정보 조회
        >>> info = sub.get_substitutes("양파")
        >>> print(info['대체재료'])
        
        >>> # 포맷팅된 정보 출력
        >>> print(sub.format_substitution_info("마늘"))
    """
    
    def __init__(self):
        self.substitution_db = self._build_database()

    def _build_database(self) -> Dict:
        """대체 재료 데이터베이스 구축"""
        return {
            # ============================================
            # 기본 채소류
            # ============================================
            "양파": {
                "대체재료": ["파", "대파", "양파가루", "샬롯", "부추"],
                "대체비율": {
                    "파": "양파 1개 = 대파 1대",
                    "대파": "양파 1개 = 대파 1대",
                    "양파가루": "양파 1개 = 양파가루 1큰술",
                    "샬롯": "양파 1개 = 샬롯 2개",
                    "부추": "양파 1개 = 부추 1줌"
                },
                "특성": {
                    "파": "단맛이 덜하고 향이 강함",
                    "대파": "단맛이 덜하고 향이 강함",
                    "양파가루": "생양파보다 단맛이 약함",
                    "샬롯": "양파보다 달고 향이 섬세함",
                    "부추": "아삭한 식감과 마늘향 특징"
                },
                "카테고리": "채소"
            },
            "대파": {
                "대체재료": ["양파", "쪽파", "부추", "시금치", "청경채"],
                "대체비율": {
                    "양파": "대파 1대 = 양파 1/2개",
                    "쪽파": "대파 1대 = 쪽파 6~8개",
                    "부추": "대파 1대 = 부추 1묶음",
                    "시금치": "대파 1대 = 시금치 100g",
                    "청경채": "대파 1대 = 청경채 2개"
                },
                "특성": {
                    "양파": "단맛이 더 강하고 향이 순함",
                    "쪽파": "향이 비슷하고 크기가 작음",
                    "부추": "향이 강하고 식감이 다름",
                    "시금치": "향은 없지만 국물 맛을 냄",
                    "청경채": "아삭한 식감과 단맛"
                },
                "카테고리": "채소"
            },
            
            # ============================================
            # 마늘/생강류
            # ============================================
            "마늘": {
                "대체재료": ["마늘가루", "다진마늘", "마늘종", "마늘기름", "마늘페이스트"],
                "대체비율": {
                    "마늘가루": "마늘 1쪽 = 마늘가루 1/4작은술",
                    "다진마늘": "마늘 1쪽 = 다진마늘 1/2작은술",
                    "마늘종": "마늘 1쪽 = 마늘종 2개",
                    "마늘기름": "마늘 1쪽 = 마늘기름 1/2작은술",
                    "마늘페이스트": "마늘 1쪽 = 마늘페이스트 1/2작은술"
                },
                "특성": {
                    "마늘가루": "향은 약하나 오래 보관 가능",
                    "다진마늘": "신선한 마늘과 비슷한 맛",
                    "마늘종": "마늘향이 은은하고 식감이 아삭함",
                    "마늘기름": "기름에 마늘향이 배어있음",
                    "마늘페이스트": "신선한 마늘과 가장 비슷"
                },
                "카테고리": "향신료"
            },
            "생강": {
                "대체재료": ["생강가루", "생강청", "생강즙", "갈은생강"],
                "대체비율": {
                    "생강가루": "생강 1쪽(1cm) = 생강가루 1/4작은술",
                    "생강청": "생강 1쪽 = 생강청 1작은술",
                    "생강즙": "생강 1쪽 = 생강즙 1/2작은술",
                    "갈은생강": "생강 1쪽 = 갈은생강 1/2작은술"
                },
                "특성": {
                    "생강가루": "향이 약하며 오래 보관 가능",
                    "생강청": "단맛이 있고 향이 부드러움",
                    "생강즙": "신선한 생강과 가장 비슷",
                    "갈은생강": "신선한 생강과 비슷하나 보관이 편리"
                },
                "카테고리": "향신료"
            },

            # ============================================
            # 고추류
            # ============================================
            "고추": {
                "대체재료": ["고춧가루", "청양고추", "홍고추", "피망", "할라피뇨"],
                "대체비율": {
                    "고춧가루": "풋고추 1개 = 고춧가루 1/2작은술",
                    "청양고추": "풋고추 1개 = 청양고추 1/2개",
                    "홍고추": "풋고추 1개 = 홍고추 1개",
                    "피망": "풋고추 1개 = 피망 1/2개",
                    "할라피뇨": "풋고추 1개 = 할라피뇨 1개"
                },
                "특성": {
                    "고춧가루": "매운맛 조절 용이",
                    "청양고추": "매운맛이 강함",
                    "홍고추": "단맛이 있고 매운맛이 적음",
                    "피망": "매운맛이 없고 달콤함",
                    "할라피뇨": "독특한 매운맛과 향"
                },
                "카테고리": "채소"
            },

            # ============================================
            # 장류/양념
            # ============================================
            "된장": {
                "대체재료": ["쌈장", "고추장", "미소된장", "청국장"],
                "대체비율": {
                    "쌈장": "된장 1큰술 = 쌈장 1큰술",
                    "고추장": "된장 1큰술 = 고추장 2/3큰술",
                    "미소된장": "된장 1큰술 = 미소된장 1.5큰술",
                    "청국장": "된장 1큰술 = 청국장 1큰술"
                },
                "특성": {
                    "쌈장": "매콤하고 달콤한 맛이 더해짐",
                    "고추장": "매운맛이 더해지고 달콤해짐",
                    "미소된장": "깔끔하고 부드러운 맛",
                    "청국장": "깊은 맛과 발효향이 강함"
                },
                "카테고리": "장류"
            },
            "간장": {
                "대체재료": ["국간장", "액젓", "소금", "맛간장", "진간장"],
                "대체비율": {
                    "국간장": "진간장 1큰술 = 국간장 1.5큰술",
                    "액젓": "진간장 1큰술 = 액젓 1큰술",
                    "소금": "진간장 1큰술 = 소금 1/2작은술",
                    "맛간장": "진간장 1큰술 = 맛간장 1큰술",
                    "진간장": "국간장 1큰술 = 진간장 2/3큰술"
                },
                "특성": {
                    "국간장": "색이 연하고 짠맛이 약함",
                    "액젓": "감칠맛이 더해짐",
                    "소금": "순수한 짠맛",
                    "맛간장": "달콤한 맛이 더해짐",
                    "진간장": "색이 진하고 단맛이 있음"
                },
                "카테고리": "장류"
            },

            # ============================================
            # 식용유/기름류
            # ============================================
            "식용유": {
                "대체재료": ["올리브유", "포도씨유", "들기름", "참기름", "버터"],
                "대체비율": {
                    "올리브유": "식용유 1큰술 = 올리브유 1큰술",
                    "포도씨유": "식용유 1큰술 = 포도씨유 1큰술",
                    "들기름": "식용유 1큰술 = 들기름 2/3큰술",
                    "참기름": "식용유 1큰술 = 참기름 1/2큰술",
                    "버터": "식용유 1큰술 = 버터 15g"
                },
                "특성": {
                    "올리브유": "고소하고 향이 있음, 발연점 주의",
                    "포도씨유": "담백하고 고온 조리 가능",
                    "들기름": "고소하고 향이 강함, 열에 약함",
                    "참기름": "고소하고 향이 매우 강함, 마무리용",
                    "버터": "고소하고 부드러운 맛, 발연점 낮음"
                },
                "카테고리": "기름"
            },
            
            # ============================================
            # 유제품
            # ============================================
            "우유": {
                "대체재료": ["두유", "아몬드밀크", "오트밀크", "코코넛밀크", "생크림"],
                "대체비율": {
                    "두유": "우유 1컵 = 두유 1컵",
                    "아몬드밀크": "우유 1컵 = 아몬드밀크 1컵",
                    "오트밀크": "우유 1컵 = 오트밀크 1컵",
                    "코코넛밀크": "우유 1컵 = 코코넛밀크 3/4컵",
                    "생크림": "우유 1컵 = 생크림 1/2컵 + 물 1/2컵"
                },
                "특성": {
                    "두유": "단백질 풍부, 콩 맛이 남",
                    "아몬드밀크": "가볍고 고소함",
                    "오트밀크": "크리미하고 단맛이 있음",
                    "코코넛밀크": "진하고 열대 향이 남",
                    "생크림": "더 진하고 부드러움"
                },
                "카테고리": "유제품"
            },
            "버터": {
                "대체재료": ["마가린", "식용유", "코코넛오일", "그릭요거트"],
                "대체비율": {
                    "마가린": "버터 1큰술 = 마가린 1큰술",
                    "식용유": "버터 1큰술 = 식용유 3/4큰술",
                    "코코넛오일": "버터 1큰술 = 코코넛오일 1큰술",
                    "그릭요거트": "버터 1큰술 = 그릭요거트 1.5큰술"
                },
                "특성": {
                    "마가린": "맛이 비슷하나 풍미가 덜함",
                    "식용유": "부드러움이 줄어듦",
                    "코코넛오일": "코코넛 향이 남을 수 있음",
                    "그릭요거트": "촉촉함 유지, 칼로리 낮음"
                },
                "카테고리": "유제품"
            },
            
            # ============================================
            # 설탕/감미료
            # ============================================
            "설탕": {
                "대체재료": ["꿀", "올리고당", "메이플시럽", "스테비아", "황설탕"],
                "대체비율": {
                    "꿀": "설탕 1큰술 = 꿀 2/3큰술",
                    "올리고당": "설탕 1큰술 = 올리고당 1큰술",
                    "메이플시럽": "설탕 1큰술 = 메이플시럽 2/3큰술",
                    "스테비아": "설탕 1큰술 = 스테비아 1/4작은술",
                    "황설탕": "설탕 1큰술 = 황설탕 1큰술"
                },
                "특성": {
                    "꿀": "풍미가 깊고 건강에 좋음",
                    "올리고당": "단맛이 덜하고 장건강에 좋음",
                    "메이플시럽": "독특한 풍미, 고가",
                    "스테비아": "칼로리 없음, 뒷맛 주의",
                    "황설탕": "약간의 캐러멜 풍미"
                },
                "카테고리": "감미료"
            }
        }

    def get_substitutes(self, ingredient: str) -> Optional[Dict]:
        """
        주어진 재료의 대체재료 정보 반환
        
        Args:
            ingredient: 재료명
            
        Returns:
            대체재료 정보 딕셔너리 또는 None
        """
        return self.substitution_db.get(ingredient)

    def get_substitute_ratio(
        self,
        original: str,
        substitute: str
    ) -> Optional[str]:
        """
        원재료와 대체재료의 비율 반환
        
        Args:
            original: 원래 재료
            substitute: 대체 재료
            
        Returns:
            대체 비율 문자열 또는 None
        """
        info = self.substitution_db.get(original)
        if info:
            return info["대체비율"].get(
                substitute,
                "정확한 대체 비율 정보가 없습니다."
            )
        return None

    def get_characteristics(
        self,
        original: str,
        substitute: str
    ) -> Optional[str]:
        """
        대체재료의 특성 정보 반환
        
        Args:
            original: 원래 재료
            substitute: 대체 재료
            
        Returns:
            특성 설명 문자열 또는 None
        """
        info = self.substitution_db.get(original)
        if info:
            return info["특성"].get(substitute, "특성 정보가 없습니다.")
        return None

    def format_substitution_info(self, ingredient: str) -> str:
        """
        대체재료 정보를 보기 좋게 포맷팅하여 반환
        
        Args:
            ingredient: 재료명
            
        Returns:
            포맷팅된 정보 문자열
        """
        info = self.get_substitutes(ingredient)
        if not info:
            return f"'{ingredient}'에 대한 대체재료 정보가 없습니다."

        result = f"[{ingredient}의 대체재료 정보]\n"
        result += f"카테고리: {info.get('카테고리', '기타')}\n\n"
        result += "대체 가능한 재료:\n"

        for sub in info["대체재료"]:
            result += f"\n• {sub}\n"
            result += f"  - 비율: {info['대체비율'][sub]}\n"
            result += f"  - 특성: {info['특성'][sub]}\n"

        return result

    def search(self, query: str) -> List[str]:
        """
        재료명으로 검색
        
        Args:
            query: 검색어
            
        Returns:
            매칭되는 재료 목록
        """
        results = []
        query_lower = query.lower()

        for ingredient in self.substitution_db.keys():
            if query_lower in ingredient.lower():
                results.append(ingredient)

        return results

    def get_by_category(self, category: str) -> List[str]:
        """
        카테고리별 재료 목록 반환
        
        Args:
            category: 카테고리명 (채소, 향신료, 장류, 기름, 유제품, 감미료)
            
        Returns:
            해당 카테고리의 재료 목록
        """
        return [
            ingredient
            for ingredient, info in self.substitution_db.items()
            if info.get('카테고리') == category
        ]

    def get_all_ingredients(self) -> List[str]:
        """모든 등록된 재료 목록 반환"""
        return list(self.substitution_db.keys())

    def get_all_categories(self) -> List[str]:
        """모든 카테고리 목록 반환"""
        categories = set()
        for info in self.substitution_db.values():
            if '카테고리' in info:
                categories.add(info['카테고리'])
        return sorted(list(categories))

    def suggest_substitutes(
        self,
        missing_ingredients: List[str]
    ) -> Dict[str, List[str]]:
        """
        여러 재료의 대체재료를 한번에 추천
        
        Args:
            missing_ingredients: 없는 재료 목록
            
        Returns:
            {재료명: [대체재료 목록]} 형태의 딕셔너리
        """
        suggestions = {}
        
        for ingredient in missing_ingredients:
            info = self.get_substitutes(ingredient)
            if info:
                suggestions[ingredient] = info['대체재료']
            else:
                suggestions[ingredient] = []
        
        return suggestions